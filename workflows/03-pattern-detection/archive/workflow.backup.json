{
  "name": "03-Pattern-Detection | Selene",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 6 * * *"
            }
          ]
        }
      },
      "id": "cron-daily",
      "name": "Daily at 6am",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "const Database = require('better-sqlite3');\n\ntry {\n  const db = new Database('/selene/data/selene.db', { readonly: true });\n  \n  const query = `-- Get theme frequency over last 30 days grouped by week\n  SELECT\n    primary_theme,\n    strftime('%Y-W%W', processed_at) as week,\n    COUNT(*) as frequency,\n    MIN(processed_at) as week_start\n  FROM processed_notes\n  WHERE processed_at >= date('now', '-30 days')\n  GROUP BY primary_theme, week\n  HAVING COUNT(*) >= 3\n  ORDER BY primary_theme, week`;\n  \n  const stmt = db.prepare(query);\n  const results = stmt.all();\n  \n  db.close();\n  \n  return results.map(row => ({ json: row }));\n  \n} catch (error) {\n  console.error('SQLite Query Error:', error);\n  throw new Error('Database query failed: ' + error.message);\n}"
      },
      "id": "sqlite-get-themes",
      "name": "Get Theme Trends",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "const themeData = $input.all();\n\n// Group by theme\nconst themeGroups = {};\nthemeData.forEach(item => {\n  const theme = item.json.primary_theme;\n  if (!themeGroups[theme]) {\n    themeGroups[theme] = [];\n  }\n  themeGroups[theme].push({\n    week: item.json.week,\n    weekStart: item.json.week_start,\n    frequency: item.json.frequency\n  });\n});\n\n// Analyze trends\nconst patterns = [];\nfor (const [theme, weeks] of Object.entries(themeGroups)) {\n  if (weeks.length < 2) continue;\n\n  const frequencies = weeks.map(w => w.frequency);\n  \n  // Calculate recent vs historical average\n  const recentAvg = frequencies.length >= 2 \n    ? frequencies.slice(-2).reduce((a, b) => a + b, 0) / 2\n    : frequencies[frequencies.length - 1];\n    \n  const historicalAvg = frequencies.length > 2\n    ? frequencies.slice(0, -2).reduce((a, b) => a + b, 0) / (frequencies.length - 2)\n    : frequencies[0];\n\n  if (historicalAvg === 0) continue;\n\n  const percentChange = ((recentAvg - historicalAvg) / historicalAvg) * 100;\n\n  // Detect significant trends (>20% change)\n  if (Math.abs(percentChange) >= 20) {\n    const trendDirection = percentChange > 0 ? 'rising' : 'falling';\n    const confidence = Math.min(0.9, Math.abs(percentChange) / 100 * 0.8);\n    \n    const displayName = theme.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n    const description = `The theme '${displayName}' has been ${trendDirection} by ${Math.abs(percentChange).toFixed(1)}% over the last 30 days. Current frequency: ${frequencies[frequencies.length - 1]}, compared to historical average of ${historicalAvg.toFixed(1)}.`;\n    \n    // Generate insights\n    let insights = '';\n    if (trendDirection === 'rising') {\n      insights = `Growing focus on ${displayName}. Consider dedicating more structured time to this area. This upward trend suggests increasing engagement or importance.`;\n    } else {\n      insights = `Declining engagement with ${displayName}. This might indicate completion of goals, shifting priorities, or reduced interest. Review if this aligns with your intentions.`;\n    }\n\n    patterns.push({\n      patternType: 'theme_trend',\n      patternName: `Theme Trend: ${displayName}`,\n      description: description,\n      confidence: confidence,\n      dataPoints: weeks.length,\n      timeRangeStart: weeks[0].weekStart,\n      timeRangeEnd: weeks[weeks.length - 1].weekStart,\n      patternData: {\n        theme: theme,\n        displayName: displayName,\n        trendDirection: trendDirection,\n        percentChange: percentChange,\n        currentFrequency: frequencies[frequencies.length - 1],\n        historicalAverage: historicalAvg,\n        weeks: weeks\n      },\n      insights: insights,\n      discoveredAt: new Date().toISOString(),\n      isActive: true\n    });\n  }\n}\n\nreturn patterns.map(p => ({ json: p }));"
      },
      "id": "function-calculate-trends",
      "name": "Calculate Theme Trends",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "const Database = require('better-sqlite3');\n\ntry {\n  const db = new Database('/selene/data/selene.db');\n  \n  const insertQuery = `INSERT INTO detected_patterns (\n    pattern_type, pattern_name, description,\n    confidence, data_points, pattern_data,\n    time_range_start, time_range_end,\n    insights, discovered_at, is_active\n  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`;\n  \n  const stmt = db.prepare(insertQuery);\n  const result = stmt.run(\n    $json.patternType,\n    $json.patternName,\n    $json.description,\n    $json.confidence,\n    $json.dataPoints,\n    JSON.stringify($json.patternData),\n    $json.timeRangeStart,\n    $json.timeRangeEnd,\n    $json.insights,\n    $json.discoveredAt,\n    $json.isActive ? 1 : 0\n  );\n  \n  db.close();\n  \n  return { json: { pattern_id: result.lastInsertRowid } };\n  \n} catch (error) {\n  console.error('SQLite Insert Error:', error);\n  throw new Error('Database insert failed: ' + error.message);\n}"
      },
      "id": "sqlite-store-pattern",
      "name": "Store Pattern",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "functionCode": "const allPatterns = $input.all();\n\n// Group patterns by confidence level\nconst highConfidence = allPatterns.filter(p => p.json.confidence >= 0.7);\nconst mediumConfidence = allPatterns.filter(p => p.json.confidence >= 0.4 && p.json.confidence < 0.7);\nconst lowConfidence = allPatterns.filter(p => p.json.confidence < 0.4);\n\n// Separate by trend direction\nconst risingTrends = allPatterns.filter(p => \n  p.json.patternData && p.json.patternData.trendDirection === 'rising'\n);\nconst fallingTrends = allPatterns.filter(p => \n  p.json.patternData && p.json.patternData.trendDirection === 'falling'\n);\n\n// Generate key insights\nconst keyInsights = [];\n\nif (highConfidence.length > 0) {\n  keyInsights.push(`ðŸŽ¯ Found ${highConfidence.length} high-confidence pattern${highConfidence.length > 1 ? 's' : ''} indicating clear trends in your thinking.`);\n}\n\nif (risingTrends.length > 0) {\n  const topRising = risingTrends\n    .sort((a, b) => b.json.confidence - a.json.confidence)\n    .slice(0, 3)\n    .map(p => p.json.patternData.displayName);\n  keyInsights.push(`ðŸ“ˆ Rising focus areas: ${topRising.join(', ')}.`);\n}\n\nif (fallingTrends.length > 0) {\n  const topFalling = fallingTrends\n    .sort((a, b) => b.json.confidence - a.json.confidence)\n    .slice(0, 3)\n    .map(p => p.json.patternData.displayName);\n  keyInsights.push(`ðŸ“‰ Declining engagement: ${topFalling.join(', ')}.`);\n}\n\nif (allPatterns.length === 0) {\n  keyInsights.push(`â„¹ï¸ No significant patterns detected yet. Continue capturing notes to build pattern history.`);\n}\n\n// Generate recommendations\nconst recommendations = [];\n\nif (risingTrends.length > 0) {\n  const topThree = risingTrends\n    .sort((a, b) => b.json.confidence - a.json.confidence)\n    .slice(0, 3)\n    .map(p => p.json.patternData.displayName);\n  recommendations.push(`ðŸ’¡ Consider dedicating more structured time to these growing focus areas: ${topThree.join(', ')}.`);\n}\n\nif (fallingTrends.length >= 3) {\n  recommendations.push(`ðŸ” Review declining themes to ensure they align with your current goals and priorities.`);\n}\n\nif (highConfidence.length >= 2) {\n  recommendations.push(`ðŸ“Š Strong patterns detected. Consider using these insights for weekly planning and goal setting.`);\n}\n\n// Build summary report\nconst report = {\n  reportId: `pattern_report_${Date.now()}`,\n  generatedAt: new Date().toISOString(),\n  timeRangeStart: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),\n  timeRangeEnd: new Date().toISOString(),\n  totalPatternsDetected: allPatterns.length,\n  highConfidencePatterns: highConfidence.length,\n  mediumConfidencePatterns: mediumConfidence.length,\n  lowConfidencePatterns: lowConfidence.length,\n  risingTrends: risingTrends.length,\n  fallingTrends: fallingTrends.length,\n  keyInsights: keyInsights,\n  recommendations: recommendations,\n  patterns: allPatterns.map(p => ({\n    name: p.json.patternName,\n    type: p.json.patternType,\n    confidence: p.json.confidence,\n    direction: p.json.patternData?.trendDirection,\n    theme: p.json.patternData?.displayName\n  }))\n};\n\nreturn {\n  json: report\n};"
      },
      "id": "function-generate-insights",
      "name": "Generate Insights Report",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "functionCode": "const Database = require('better-sqlite3');\n\ntry {\n  const db = new Database('/selene/data/selene.db');\n  \n  const insertQuery = `INSERT INTO pattern_reports (\n    report_id, generated_at, time_range_start, time_range_end,\n    total_patterns, high_confidence_count, medium_confidence_count, low_confidence_count,\n    rising_trends_count, falling_trends_count,\n    key_insights, recommendations, report_data\n  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`;\n  \n  const stmt = db.prepare(insertQuery);\n  stmt.run(\n    $json.reportId,\n    $json.generatedAt,\n    $json.timeRangeStart,\n    $json.timeRangeEnd,\n    $json.totalPatternsDetected,\n    $json.highConfidencePatterns,\n    $json.mediumConfidencePatterns,\n    $json.lowConfidencePatterns,\n    $json.risingTrends,\n    $json.fallingTrends,\n    JSON.stringify($json.keyInsights),\n    JSON.stringify($json.recommendations),\n    JSON.stringify($json.patterns)\n  );\n  \n  db.close();\n  \n  return {\n    json: {\n      success: true,\n      reportId: $json.reportId,\n      patternsDetected: $json.totalPatternsDetected,\n      message: 'Pattern analysis report stored successfully'\n    }\n  };\n  \n} catch (error) {\n  console.error('SQLite Insert Error:', error);\n  throw new Error('Database insert failed: ' + error.message);\n}"
      },
      "id": "sqlite-store-report",
      "name": "Store Insights Report",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Daily at 6am": {
      "main": [
        [
          {
            "node": "Get Theme Trends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Theme Trends": {
      "main": [
        [
          {
            "node": "Calculate Theme Trends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Theme Trends": {
      "main": [
        [
          {
            "node": "Store Pattern",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Pattern": {
      "main": [
        [
          {
            "node": "Generate Insights Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Insights Report": {
      "main": [
        [
          {
            "node": "Store Insights Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Selene",
      "id": "selene-tag"
    }
  ],
  "meta": {
    "instanceId": "selene-local"
  },
  "pinData": {}
}

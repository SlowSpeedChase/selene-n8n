{
  "name": "05-Sentiment-Analysis | Selene",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/analyze-sentiment",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-sentiment-trigger",
      "name": "Webhook: Analyze Sentiment",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "selene-analyze-sentiment-webhook"
    },
    {
      "parameters": {
        "functionCode": "const Database = require('better-sqlite3');\n\n// Get processedNoteId from webhook payload\nconst body = $input.item.json.body || $input.item.json;\nconst processedNoteId = body.processedNoteId || body.processed_note_id;\n\nif (!processedNoteId) {\n  throw new Error('processedNoteId is required in webhook payload');\n}\n\ntry {\n  const db = new Database('/selene/data/selene.db', { readonly: true });\n  \n  const query = `SELECT pn.id, pn.raw_note_id, rn.title, rn.content, \n                        pn.primary_theme, pn.concepts, pn.secondary_themes\n                 FROM processed_notes pn\n                 JOIN raw_notes rn ON pn.raw_note_id = rn.id\n                 WHERE pn.id = ?\n                 AND pn.sentiment_analyzed = 0`;\n  \n  const stmt = db.prepare(query);\n  const result = stmt.get(processedNoteId);\n  \n  db.close();\n  \n  if (!result) {\n    throw new Error(`Processed note ${processedNoteId} not found or already analyzed`);\n  }\n  \n  return { json: result };\n  \n} catch (error) {\n  console.error('SQLite Query Error:', error);\n  throw new Error('Database query failed: ' + error.message);\n}"
      },
      "id": "sqlite-get-unanalyzed",
      "name": "Get Note for Sentiment Analysis",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "// Validate input data exists\nif (!$json || !$json.content || !$json.id) {\n  throw new Error('No note data received - workflow should not have reached this node');\n}\n\nconst content = $json.content;\nconst title = $json.title;\nconst noteId = $json.id;\nconst rawNoteId = $json.raw_note_id;\nconst theme = $json.primary_theme || 'unknown';\nconst concepts = $json.concepts || '';\nconst secondaryThemes = $json.secondary_themes || '';\n\n// Enhanced system prompt with better ADHD awareness\nconst systemPrompt = `You are an expert sentiment and emotional intelligence analyzer specializing in ADHD thought patterns.\n\nYour job is to deeply analyze text and identify:\n\n1. Overall sentiment (positive, negative, neutral, mixed)\n2. Emotional tone with ADHD-specific states (calm, excited, anxious, frustrated, overwhelmed, hyperfocused, scattered, determined, burnt_out, energized)\n3. Energy level (high, medium, low)\n4. Stress and overwhelm indicators\n5. Confidence and self-efficacy signals\n6. Executive function markers\n\nADHD-SPECIFIC DETECTION PATTERNS:\n\nðŸ§  OVERWHELM INDICATORS:\n- Multiple unfinished thoughts or topics\n- Language: \"too much\", \"can't handle\", \"drowning\", \"everything at once\"\n- Long lists without clear prioritization (>7 items)\n- Repetitive concerns or circular thinking\n- Time pressure anxiety\n- Decision paralysis cues\n\nðŸŽ¯ HYPERFOCUS INDICATORS:\n- Extreme detail on single topic\n- Time-blindness mentions (\"been at this for hours\", \"lost track of time\")\n- Deep technical depth\n- Flow state language (\"in the zone\", \"dialed in\")\n- Single-minded pursuit mentions\n- Reluctance to switch tasks\n\nâš ï¸ EXECUTIVE DYSFUNCTION INDICATORS:\n- Difficulty initiating tasks (\"can't get started\", \"stuck\")\n- Organization struggles (\"don't know where to begin\")\n- Priority confusion (\"everything seems important\")\n- Procrastination awareness (\"should do X but doing Y\")\n- Planning difficulties\n- Working memory challenges (\"keep forgetting\")\n\nðŸŒªï¸ SCATTERED/DISTRACTIBILITY INDICATORS:\n- Rapid topic switching\n- Incomplete sentences or thoughts\n- Multiple tangents\n- \"Oh and also...\" patterns\n- Difficulty maintaining focus on one idea\n\nðŸ”¥ BURNOUT INDICATORS:\n- Exhaustion mentions\n- Loss of motivation\n- \"Going through the motions\"\n- Decreased enthusiasm for usually interesting topics\n- Self-criticism about productivity\n\nðŸ’ª POSITIVE ADHD TRAITS:\n- Creative connections between concepts\n- Innovative problem-solving\n- High enthusiasm and energy\n- Quick pattern recognition\n- Passionate engagement\n\nCRITICAL OUTPUT REQUIREMENTS:\n- Return ONLY valid JSON, no explanations\n- Be evidence-based, not assumptive\n- Use exact enum values provided below\n- Rate confidence honestly (0.0-1.0)\n\nJSON FORMAT (return ONLY this, nothing else):\n{\n  \"overall_sentiment\": \"positive|negative|neutral|mixed\",\n  \"sentiment_score\": 0.0-1.0,\n  \"emotional_tone\": \"calm|excited|anxious|frustrated|overwhelmed|hyperfocused|scattered|determined|burnt_out|energized|content|motivated\",\n  \"energy_level\": \"high|medium|low\",\n  \"stress_indicators\": true|false,\n  \"confidence_level\": \"high|medium|low\",\n  \"key_emotions\": [\"emotion1\", \"emotion2\", \"emotion3\"],\n  \"adhd_markers\": {\n    \"overwhelm\": true|false,\n    \"hyperfocus\": true|false,\n    \"executive_dysfunction\": true|false,\n    \"scattered\": true|false,\n    \"burnout\": true|false,\n    \"time_blindness\": true|false,\n    \"positive_traits\": true|false\n  },\n  \"cognitive_load\": \"high|medium|low\",\n  \"self_efficacy\": \"high|medium|low\",\n  \"analysis_confidence\": 0.0-1.0,\n  \"key_phrases\": [\"phrase1\", \"phrase2\"],\n  \"reasoning\": \"One sentence explaining the primary emotional state detected\"\n}`;\n\n// Enhanced user prompt with context\nconst contentPreview = content.substring(0, 3000); // Increased from 2000\nconst userPrompt = `Analyze the sentiment, emotional state, and ADHD patterns in this note:\n\n**Title:** ${title}\n**Primary Theme:** ${theme}\n**Key Concepts:** ${concepts}\n**Secondary Themes:** ${secondaryThemes}\n\n**Content:**\n${contentPreview}\n\n${content.length > 3000 ? '\\n[Content truncated - ' + content.length + ' total characters]' : ''}\n\nProvide your analysis as JSON only. Look carefully for ADHD-specific patterns like overwhelm, hyperfocus, executive dysfunction, scattered thinking, and time-blindness. Be sensitive to both challenges and strengths.`;\n\nreturn {\n  json: {\n    noteId: noteId,\n    rawNoteId: rawNoteId,\n    title: title,\n    theme: theme,\n    systemPrompt: systemPrompt,\n    userPrompt: userPrompt,\n    contentLength: content.length\n  }\n};"
      },
      "id": "function-build-sentiment-prompt",
      "name": "Build Enhanced Sentiment Prompt",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:11434/api/generate",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "mistral:7b"
            },
            {
              "name": "prompt",
              "value": "={{ $json.userPrompt }}"
            },
            {
              "name": "system",
              "value": "={{ $json.systemPrompt }}"
            },
            {
              "name": "stream",
              "value": "={{ false }}"
            },
            {
              "name": "options",
              "value": "={{ { \"temperature\": 0.35, \"num_predict\": 2000, \"top_p\": 0.9 } }}"
            }
          ]
        },
        "options": {
          "timeout": 90000
        }
      },
      "id": "http-ollama-sentiment",
      "name": "Ollama: Enhanced Sentiment Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "functionCode": "const response = $json.response;\nconst noteId = $('Build Enhanced Sentiment Prompt').item.json.noteId;\nconst rawNoteId = $('Build Enhanced Sentiment Prompt').item.json.rawNoteId;\nconst contentLength = $('Build Enhanced Sentiment Prompt').item.json.contentLength;\n\n// Default structure with enhanced fields\nlet sentimentData = {\n  overall_sentiment: 'neutral',\n  sentiment_score: 0.5,\n  emotional_tone: 'calm',\n  energy_level: 'medium',\n  stress_indicators: false,\n  confidence_level: 'medium',\n  key_emotions: [],\n  adhd_markers: {\n    overwhelm: false,\n    hyperfocus: false,\n    executive_dysfunction: false,\n    scattered: false,\n    burnout: false,\n    time_blindness: false,\n    positive_traits: false\n  },\n  cognitive_load: 'medium',\n  self_efficacy: 'medium',\n  analysis_confidence: 0.5,\n  key_phrases: [],\n  reasoning: 'Default analysis applied'\n};\n\ntry {\n  // Try to parse JSON from response\n  let jsonStr = response.trim();\n  \n  // Handle case where response might have explanation before JSON\n  const jsonMatch = jsonStr.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    jsonStr = jsonMatch[0];\n  }\n  \n  const parsed = JSON.parse(jsonStr);\n  sentimentData = { ...sentimentData, ...parsed };\n  \n  // Validation - ensure enums are valid\n  const validSentiments = ['positive', 'negative', 'neutral', 'mixed'];\n  if (!validSentiments.includes(sentimentData.overall_sentiment)) {\n    sentimentData.overall_sentiment = 'neutral';\n    sentimentData.analysis_confidence *= 0.8;\n  }\n  \n  const validEnergy = ['high', 'medium', 'low'];\n  if (!validEnergy.includes(sentimentData.energy_level)) {\n    sentimentData.energy_level = 'medium';\n  }\n  \n} catch (e) {\n  // Enhanced fallback parsing\n  const lower = response.toLowerCase();\n  \n  // Sentiment detection\n  if (/(very positive|excellent|amazing|excited|love|great)/i.test(lower)) {\n    sentimentData.overall_sentiment = 'positive';\n    sentimentData.sentiment_score = 0.8;\n  } else if (/(positive|good|happy|optimistic)/i.test(lower)) {\n    sentimentData.overall_sentiment = 'positive';\n    sentimentData.sentiment_score = 0.65;\n  } else if (/(negative|bad|frustrated|angry|upset)/i.test(lower)) {\n    sentimentData.overall_sentiment = 'negative';\n    sentimentData.sentiment_score = 0.35;\n  } else if (/(very negative|terrible|awful|hate|worst)/i.test(lower)) {\n    sentimentData.overall_sentiment = 'negative';\n    sentimentData.sentiment_score = 0.2;\n  } else if (/(mixed|conflicted|both|however)/i.test(lower)) {\n    sentimentData.overall_sentiment = 'mixed';\n    sentimentData.sentiment_score = 0.5;\n  }\n  \n  // ADHD marker detection\n  if (/(overwhelm|too much|can't handle|drowning|everything at once)/i.test(lower)) {\n    sentimentData.adhd_markers.overwhelm = true;\n    sentimentData.stress_indicators = true;\n    sentimentData.cognitive_load = 'high';\n    sentimentData.emotional_tone = 'overwhelmed';\n  }\n  \n  if (/(hyperfocus|in the zone|lost track of time|been at this for hours|dialed in)/i.test(lower)) {\n    sentimentData.adhd_markers.hyperfocus = true;\n    sentimentData.energy_level = 'high';\n    sentimentData.emotional_tone = 'hyperfocused';\n  }\n  \n  if (/(can't get started|stuck|don't know where to begin|procrastinat)/i.test(lower)) {\n    sentimentData.adhd_markers.executive_dysfunction = true;\n    sentimentData.self_efficacy = 'low';\n  }\n  \n  if (/(scattered|distracted|jumping between|can't focus|all over)/i.test(lower)) {\n    sentimentData.adhd_markers.scattered = true;\n    sentimentData.emotional_tone = 'scattered';\n  }\n  \n  if (/(burnt out|exhausted|no motivation|going through motions)/i.test(lower)) {\n    sentimentData.adhd_markers.burnout = true;\n    sentimentData.energy_level = 'low';\n    sentimentData.emotional_tone = 'burnt_out';\n  }\n  \n  // Energy detection\n  if (/(high energy|pumped|ready to go|energized)/i.test(lower)) {\n    sentimentData.energy_level = 'high';\n  } else if (/(tired|low energy|drained|exhausted)/i.test(lower)) {\n    sentimentData.energy_level = 'low';\n  }\n  \n  sentimentData.analysis_confidence = 0.35; // Lower confidence for fallback\n  sentimentData.reasoning = 'Fallback regex parsing used due to JSON parse failure';\n}\n\n// Add metadata\nsentimentData.content_length = contentLength;\nsentimentData.parsed_via = sentimentData.analysis_confidence > 0.4 ? 'json' : 'fallback';\n\nreturn {\n  json: {\n    noteId: noteId,\n    rawNoteId: rawNoteId,\n    sentimentData: sentimentData,\n    analyzedAt: new Date().toISOString()\n  }\n};"
      },
      "id": "function-parse-sentiment",
      "name": "Parse Enhanced Sentiment Results",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "functionCode": "const Database = require('better-sqlite3');\n\nconst noteId = $json.noteId;\nconst rawNoteId = $json.rawNoteId;\nconst sentimentData = $json.sentimentData;\nconst analyzedAt = $json.analyzedAt;\n\ntry {\n  const db = new Database('/selene/data/selene.db');\n  \n  // Update processed_notes with sentiment data\n  const updateQuery = `UPDATE processed_notes\n                       SET sentiment_analyzed = 1,\n                           sentiment_data = ?,\n                           overall_sentiment = ?,\n                           sentiment_score = ?,\n                           emotional_tone = ?,\n                           energy_level = ?,\n                           sentiment_analyzed_at = ?\n                       WHERE id = ?`;\n  \n  const updateStmt = db.prepare(updateQuery);\n  updateStmt.run(\n    JSON.stringify(sentimentData),\n    sentimentData.overall_sentiment,\n    sentimentData.sentiment_score,\n    sentimentData.emotional_tone,\n    sentimentData.energy_level,\n    analyzedAt,\n    noteId\n  );\n  \n  // Insert into sentiment_history\n  const insertQuery = `INSERT INTO sentiment_history (\n                         processed_note_id, raw_note_id,\n                         overall_sentiment, sentiment_score,\n                         emotional_tone, energy_level,\n                         stress_indicators, key_emotions,\n                         adhd_markers, analysis_confidence,\n                         analyzed_at\n                       ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`;\n  \n  const insertStmt = db.prepare(insertQuery);\n  insertStmt.run(\n    noteId,\n    rawNoteId,\n    sentimentData.overall_sentiment,\n    sentimentData.sentiment_score,\n    sentimentData.emotional_tone,\n    sentimentData.energy_level,\n    sentimentData.stress_indicators ? 1 : 0,\n    JSON.stringify(sentimentData.key_emotions || []),\n    JSON.stringify(sentimentData.adhd_markers),\n    sentimentData.analysis_confidence,\n    analyzedAt\n  );\n  \n  db.close();\n  \n  return {\n    json: {\n      success: true,\n      noteId: noteId,\n      sentiment: sentimentData.overall_sentiment,\n      confidence: sentimentData.analysis_confidence\n    }\n  };\n  \n} catch (error) {\n  console.error('SQLite Update Error:', error);\n  throw new Error(`Failed to store sentiment: ${error.message}`);\n}"
      },
      "id": "sqlite-store-sentiment",
      "name": "Store Enhanced Sentiment",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/obsidian-export",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"noteId\": $('Get Note for Sentiment Analysis').item.json.raw_note_id } }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "http-trigger-obsidian",
      "name": "Trigger Obsidian Export",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "functionCode": "const noteId = $('Get Note for Sentiment Analysis').item.json.id;\nconst rawNoteId = $('Get Note for Sentiment Analysis').item.json.raw_note_id;\nconst sentiment = $('Store Enhanced Sentiment').item.json.sentiment;\nconst confidence = $('Store Enhanced Sentiment').item.json.confidence;\n\nreturn {\n  json: {\n    success: true,\n    processedNoteId: noteId,\n    rawNoteId: rawNoteId,\n    sentiment: sentiment,\n    analysisConfidence: confidence,\n    message: `Sentiment analysis complete for note ${rawNoteId}, export triggered`\n  }\n};"
      },
      "id": "function-build-response",
      "name": "Build Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "webhook-respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2050, 200]
    }
  ],
  "connections": {
    "Webhook: Analyze Sentiment": {
      "main": [
        [
          {
            "node": "Get Note for Sentiment Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Note for Sentiment Analysis": {
      "main": [
        [
          {
            "node": "Build Enhanced Sentiment Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Enhanced Sentiment Prompt": {
      "main": [
        [
          {
            "node": "Ollama: Enhanced Sentiment Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama: Enhanced Sentiment Analysis": {
      "main": [
        [
          {
            "node": "Parse Enhanced Sentiment Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Enhanced Sentiment Results": {
      "main": [
        [
          {
            "node": "Store Enhanced Sentiment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Enhanced Sentiment": {
      "main": [
        [
          {
            "node": "Trigger Obsidian Export",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Obsidian Export": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Selene",
      "id": "selene-tag"
    },
    {
      "name": "Enhanced",
      "id": "enhanced-tag"
    },
    {
      "name": "v2",
      "id": "v2-tag"
    }
  ],
  "meta": {
    "instanceId": "selene-local"
  },
  "pinData": {}
}

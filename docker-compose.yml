services:
  # n8n Workflow Automation
  n8n:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: selene-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"     # n8n web interface
    environment:
      # Basic Configuration
      # Note: Authentication is mandatory in n8n v1.x+
      # You must create an owner account on first startup via the web UI

      # Host Configuration
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-http://localhost:5678}

      # Execution Settings
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168  # Keep executions for 7 days

      # Timezone (adjust to your timezone)
      - GENERIC_TIMEZONE=${TIMEZONE:-America/Los_Angeles}
      - TZ=${TIMEZONE:-America/Los_Angeles}

      # Performance
      - N8N_PAYLOAD_SIZE_MAX=16
      - N8N_METRICS=false

      # Database Configuration (recommended settings)
      - DB_SQLITE_POOL_SIZE=5

      # Task Runners (recommended for future compatibility)
      - N8N_RUNNERS_ENABLED=true

      # Disable telemetry for privacy
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
      - N8N_TEMPLATES_ENABLED=false

      # Community nodes (for SQLite support)
      - N8N_COMMUNITY_PACKAGES_ENABLED=true

      # Install n8n-nodes-sqlite community package on startup
      # This enables the SQLite node used in workflows 03, 04, 05, 06
      - N8N_COMMUNITY_PACKAGES_INSTALL=n8n-nodes-sqlite

      # Allow better-sqlite3 and crypto in Function nodes
      - NODE_FUNCTION_ALLOW_EXTERNAL=better-sqlite3,crypto
      - NODE_PATH=/home/node/.n8n/node_modules

      # Security
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false  # Needed for workflows to access environment
      - N8N_SECURE_COOKIE=false  # Required for non-HTTPS local access

      # Custom environment variables for workflows
      - SELENE_DB_PATH=/selene/data/selene.db
      - OBSIDIAN_VAULT_PATH=/obsidian
      - OLLAMA_BASE_URL=http://localhost:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-mistral:7b}

      # Test environment variables
      - SELENE_TEST_DB_PATH=/selene/data-test/selene-test.db
      - OBSIDIAN_TEST_VAULT_PATH=/obsidian-test

    volumes:
      # Persistent n8n data
      - n8n_data:/home/node/.n8n

      # Production mounts
      # Mount Selene database (read/write access)
      - ${SELENE_DATA_PATH:-./data}:/selene/data:rw

      # Mount Obsidian vault (read/write access)
      - ${OBSIDIAN_VAULT_PATH:-./vault}:/obsidian:rw

      # Test environment mounts
      # Mount test database (read/write access)
      - ${SELENE_TEST_DATA_PATH:-./data-test}:/selene/data-test:rw

      # Mount test Obsidian vault (read/write access)
      - ${OBSIDIAN_TEST_VAULT_PATH:-./vault-test}:/obsidian-test:rw

      # Mount workflows for easy import
      - ./:/workflows:ro

    # Note: On macOS, we need to use host.docker.internal instead of localhost to access Ollama
    # The workflows are configured to use http://host.docker.internal:11434 for Ollama

    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allows container to access host services

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # SQLite Admin Interface (Optional - for database management)
  sqlite-web:
    image: coleifer/sqlite-web:latest
    container_name: selene-sqlite-admin
    restart: unless-stopped
    network_mode: "host"  # Use host network for consistency
    environment:
      - SQLITE_DATABASE=/data/selene.db
    volumes:
      - ${SELENE_DATA_PATH:-~/selene/data}:/data:rw
    profiles:
      - admin  # Only start with: docker-compose --profile admin up
    # Accessible at: http://localhost:8080 (not 8090, using host network)

volumes:
  n8n_data:
    driver: local
    name: selene_n8n_data

# Note: Networks section removed - using host network mode for direct access to Ollama
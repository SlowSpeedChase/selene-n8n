# Phase 7.2: SeleneChat Planning Integration

**Status:** Design Complete
**Created:** 2025-12-31
**Author:** Chase Easterling + Claude

---

## Overview

Phase 7.2 adds planning capabilities to SeleneChat, enabling guided breakdown conversations for `needs_planning` items flagged by Phase 7.1. Uses dual AI routing: Ollama for sensitive note queries, Claude API for non-sensitive planning conversations.

**Key Innovation:** Single app experience with privacy-aware AI routing. Planning methodology is externalized to editable files, allowing workflow evolution without code changes.

---

## Architecture

### High-Level View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SeleneChat                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Chat   â”‚  Search  â”‚  Planning  â† NEW TAB                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  AI Routing (PrivacyRouter.swift)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SENSITIVE (Ollama)     â”‚ NON-SENSITIVE (Claude API)         â”‚   â”‚
â”‚  â”‚                        â”‚                                     â”‚   â”‚
â”‚  â”‚ â€¢ Note content queries â”‚ â€¢ Planning conversations           â”‚   â”‚
â”‚  â”‚ â€¢ Classification       â”‚ â€¢ Task breakdown                   â”‚   â”‚
â”‚  â”‚ â€¢ Journaling/emotions  â”‚ â€¢ Scoping advice                   â”‚   â”‚
â”‚  â”‚ â€¢ Thread flagging      â”‚ â€¢ Progress reviews                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                              â”‚
â”‚                                      â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ThingsURLService.swift                                        â”‚  â”‚
â”‚  â”‚ â€¢ things:///add?title=...&notes=[selene:note-42]             â”‚  â”‚
â”‚  â”‚ â€¢ Automatic task creation from planning conversations        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ prompts/planning/  (methodology files - editable)            â”‚  â”‚
â”‚  â”‚ â€¢ breakdown-questions.md                                      â”‚  â”‚
â”‚  â”‚ â€¢ task-extraction.md                                          â”‚  â”‚
â”‚  â”‚ â€¢ resurface-triggers.yaml                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Design Principles

1. **Things is the task database** - No task duplication in Selene. We only store relationship links.
2. **Methodology is configuration** - Planning prompts, triggers, and behaviors live in editable files.
3. **Privacy-aware routing** - Sensitive content stays local (Ollama), planning uses cloud (Claude API).
4. **Single app experience** - No context switching between SeleneChat and Claude Desktop.

---

## Two-Layer Architecture

### Technical Layer (Swift Code)

Handles API calls, database access, URL scheme execution. Changes rarely.

| File | Responsibility |
|------|----------------|
| `ClaudeAPIService.swift` | Call Claude API for planning conversations |
| `ThingsURLService.swift` | Create/open tasks via Things URL scheme |
| `PlanningService.swift` | Orchestrate planning sessions, manage state |
| `PromptLoader.swift` | Read methodology files at runtime |
| `PlanningView.swift` | Thread list + conversation UI |
| `PlanningConversationView.swift` | Guided breakdown chat interface |

### Methodology Layer (Editable Files)

Controls planning behavior. Evolve without code changes.

```
prompts/planning/
â”œâ”€â”€ breakdown-questions.md    # Question sequences for guided breakdown
â”œâ”€â”€ task-extraction.md        # Patterns for detecting actionable items
â”œâ”€â”€ resurface-triggers.yaml   # Thresholds for thread resurfacing
â””â”€â”€ conversation-templates.md # Response patterns and system prompts
```

---

## Data Model

### Things as Task Database

Things 3 stores all task data. SeleneChat only tracks relationships.

**Task metadata in Things:**
- Title: Task text
- Tags: `#high-energy`, `#low-energy`, `#selene`
- Notes field: `[selene:note-42:thread-7]` for traceability

### Selene Database (Relationships Only)

```sql
-- Minimal linking table
CREATE TABLE task_links (
    things_task_id TEXT PRIMARY KEY,      -- The real task lives in Things
    raw_note_id INTEGER,                   -- Source note
    discussion_thread_id INTEGER,          -- Planning session that created it
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (raw_note_id) REFERENCES raw_notes(id),
    FOREIGN KEY (discussion_thread_id) REFERENCES discussion_threads(id)
);

CREATE INDEX idx_task_links_thread ON task_links(discussion_thread_id);
CREATE INDEX idx_task_links_note ON task_links(raw_note_id);
```

### Existing Tables Used

- `discussion_threads` - From Phase 7.1, stores `needs_planning` items
- `raw_notes` - Source notes

---

## UI Design

### Planning Tab States

**State 1: Thread List (no active session)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Planning                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Threads to Continue                                    â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ "Redo my personal website"                         â”‚â”‚
â”‚  â”‚ planning â€¢ 2 hours ago                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ "Career pivot ideas"                               â”‚â”‚
â”‚  â”‚ planning â€¢ 1 day ago                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ "Review progress on fitness goals"                 â”‚â”‚
â”‚  â”‚ review â€¢ 50% tasks done                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                         â”‚
â”‚  Empty state: "Nothing to plan right now"              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**State 2: Planning Conversation (session active)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Back to threads                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Original note:                                         â”‚
â”‚  "I want to redo my personal website - it's outdated   â”‚
â”‚   and doesn't reflect my current work"                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                         â”‚
â”‚  ðŸ¤– This is a bigger project! What's the first         â”‚
â”‚     concrete step you could take to get started?       â”‚
â”‚                                                         â”‚
â”‚  ðŸ‘¤ I guess I need to figure out what platform to use  â”‚
â”‚                                                         â”‚
â”‚  ðŸ¤– Good starting point. What would help you decide -  â”‚
â”‚     researching options or listing your requirements?  â”‚
â”‚                                                         â”‚
â”‚  ðŸ‘¤ Probably list what I actually need first           â”‚
â”‚                                                         â”‚
â”‚  ðŸ¤– Makes sense. That's a clear action.                â”‚
â”‚     âœ… Task sent to Things: "List website requirements"â”‚
â”‚                                                         â”‚
â”‚     What's blocking you from doing that right now?     â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Type your response...                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Thread Row Information

- Thread prompt (from `discussion_threads.prompt`)
- Thread type badge: `planning` | `followup` | `question` | `review`
- Time since created or resurface reason
- Task progress indicator (if tasks exist)

---

## Bidirectional Things Flow

### Thread Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pending  â”‚â”€â”€â”€â–ºâ”‚  active  â”‚â”€â”€â”€â–ºâ”‚ completedâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²               â”‚
     â”‚               â–¼
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  review  â”‚â—„â”€â”€â”€ Resurface triggers
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Resurface Triggers

Configured in `resurface-triggers.yaml`:

```yaml
progress_trigger:
  threshold_percent: 50
  message: "Good progress! Ready to plan next steps?"

stuck_trigger:
  days_inactive: 3
  message: "This seems stuck. Want to rethink the approach?"

completion_trigger:
  threshold_percent: 100
  message: "All tasks done! Want to reflect or plan what's next?"
```

### Status Checking

Query Things directly via AppleScript when Planning tab opens:

```swift
func checkTaskStatus(thingsTaskId: String) async throws -> TaskStatus {
    let script = """
    tell application "Things3"
        set theTodo to to do id "\(thingsTaskId)"
        return status of theTodo as string
    end tell
    """
    // Execute and parse result
}
```

---

## Guided Breakdown Conversation

### Claude API Integration

```swift
class ClaudeAPIService: ObservableObject {
    private let apiKey: String  // From environment/keychain
    private let baseURL = "https://api.anthropic.com/v1/messages"

    func planningMessage(
        userMessage: String,
        context: PlanningContext,
        systemPrompt: String
    ) async throws -> PlanningResponse {
        let messages = context.conversationHistory + [
            ["role": "user", "content": userMessage]
        ]

        let body: [String: Any] = [
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 1024,
            "system": systemPrompt,
            "messages": messages
        ]

        // Make API call, parse response
        // Extract any tasks from response
        // Return PlanningResponse with message + extracted tasks
    }
}
```

### System Prompt (from methodology file)

```markdown
---
name: guided-breakdown
version: 1.0
---

You are a planning assistant helping break down goals into actionable tasks.
Ask ONE question at a time. When the user's response contains a clear,
specific action, extract it as a task.

Context:
- Original note: {{note.content}}
- Thread prompt: {{thread.prompt}}
- Tasks already created: {{existingTasks}}

Your question types (cycle through as needed):
1. "What's the first concrete step you could take?"
2. "What's blocking you from starting?"
3. "Can you break that down smaller?"
4. "What would 'done' look like for this?"
5. "What's the next step after that?"

When extracting a task, include in your response:
[TASK: verb + object | energy: low/medium/high | minutes: 5/15/30/60/120/240]

When planning feels complete, ask: "Does this cover what you need,
or is there more to plan?"
```

### Task Extraction

When Claude's response contains `[TASK: ...]`, automatically:
1. Parse task details
2. Create in Things via URL scheme
3. Store relationship in `task_links`
4. Show inline confirmation in UI

---

## Things URL Scheme Integration

### Creating Tasks

```swift
class ThingsURLService {
    func createTask(
        title: String,
        notes: String? = nil,
        tags: [String] = [],
        deadline: Date? = nil,
        sourceNoteId: Int? = nil,
        threadId: Int? = nil
    ) async throws -> String? {
        var components = URLComponents(string: "things:///add")!
        var queryItems = [
            URLQueryItem(name: "title", value: title),
            URLQueryItem(name: "show-quick-entry", value: "false")
        ]

        // Add selene metadata to notes field
        var notesContent = notes ?? ""
        if let noteId = sourceNoteId, let tid = threadId {
            notesContent += "\n\n[selene:note-\(noteId):thread-\(tid)]"
        }
        if !notesContent.isEmpty {
            queryItems.append(URLQueryItem(name: "notes", value: notesContent))
        }

        // Add tags
        let allTags = tags + ["selene"]
        queryItems.append(URLQueryItem(name: "tags", value: allTags.joined(separator: ",")))

        // Add auth token for creation
        if let token = getAuthToken() {
            queryItems.append(URLQueryItem(name: "auth-token", value: token))
        }

        // x-callback for getting task ID
        queryItems.append(URLQueryItem(name: "x-success", value: "selenechat://things-callback"))

        components.queryItems = queryItems

        guard let url = components.url else { throw ThingsError.invalidURL }
        NSWorkspace.shared.open(url)

        // Wait for callback with things_task_id
        return await waitForCallback()
    }
}
```

### URL Scheme Reference

| Action | URL |
|--------|-----|
| Add task | `things:///add?title=...&notes=...&tags=...` |
| Show task | `things:///show?id=...` |
| Search | `things:///search?query=...` |

---

## Implementation Checklist

### Phase 7.2a: Foundation
- [ ] Add `task_links` table migration
- [ ] Create `ClaudeAPIService.swift`
- [ ] Create `ThingsURLService.swift`
- [ ] Create `PromptLoader.swift`
- [ ] Create initial methodology files

### Phase 7.2b: Planning Tab
- [ ] Add "Planning" to ContentView navigation
- [ ] Create `PlanningView.swift` (thread list)
- [ ] Create `PlanningThreadRow.swift`
- [ ] Query `discussion_threads` from database

### Phase 7.2c: Planning Conversations
- [ ] Create `PlanningConversationView.swift`
- [ ] Integrate Claude API for responses
- [ ] Implement task extraction from responses
- [ ] Create tasks in Things automatically
- [ ] Store relationships in `task_links`

### Phase 7.2d: Bidirectional Flow
- [ ] Implement Things status checking via AppleScript
- [ ] Add resurface trigger logic
- [ ] Update thread status based on task progress
- [ ] Add "review" state UI

### Phase 7.2e: Testing & Polish
- [ ] Unit tests for services
- [ ] Integration tests for Things URL scheme
- [ ] Test methodology file loading
- [ ] UI polish and error handling

---

## Configuration

### Environment Variables

```bash
ANTHROPIC_API_KEY=sk-ant-...  # Claude API key
THINGS_AUTH_TOKEN=...          # From Things Settings > General > Things URLs
```

### Methodology File Location

```
/Users/chaseeasterling/selene-n8n/prompts/planning/
```

SeleneChat reads these at runtime. Edit to evolve planning behavior without rebuilding.

---

## Testing Strategy

### Unit Tests
- `ClaudeAPIService`: Mock API responses, verify parsing
- `ThingsURLService`: Verify URL construction
- `PromptLoader`: Test methodology file parsing
- `PlanningService`: Test thread state transitions

### Integration Tests
- Create task via URL scheme, verify in Things
- Full planning conversation flow
- Resurface trigger activation

### Manual Testing
- Real planning sessions with various note types
- Verify task metadata appears correctly in Things
- Test methodology file changes take effect

---

## Success Metrics

- [ ] Planning conversations feel helpful (user feedback)
- [ ] Tasks created in Things within 2 seconds
- [ ] Methodology changes work without code rebuild
- [ ] Resurface triggers activate correctly
- [ ] Single app experience (no context switching)

---

## Future Enhancements (Phase 7.3+)

- Cloud AI sanitization layer for sensitive planning
- Contextual surfacing ("This connects to...")
- Pattern recognition from completed tasks
- Time blocking integration

---

## Related Documentation

- [Phase 7.1 Design](./2025-12-30-task-extraction-planning-design.md)
- [Things URL Scheme](https://culturedcode.com/things/support/articles/2803573/)
- [Things AppleScript Guide](https://culturedcode.com/things/download/Things3AppleScriptGuide.pdf)
- [Claude API Documentation](https://docs.anthropic.com/claude/reference/messages_post)

---

## Sources

- [Things URL Scheme Documentation](https://culturedcode.com/things/support/articles/2803573/)
- [Things AppleScript Support](https://culturedcode.com/things/support/articles/2803572/)
- [things-mcp GitHub](https://github.com/hildersantos/things-mcp)

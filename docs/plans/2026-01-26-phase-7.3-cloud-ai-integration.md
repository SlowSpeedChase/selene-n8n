# Phase 7.3: Cloud AI Integration Design

**Created:** 2026-01-26  
**Status:** Planning  
**Goal:** Add cloud AI for complex planning with privacy-preserving sanitization

---

## Problem Statement

Current SeleneChat uses only local Ollama (mistral:7b) for all AI interactions. While this ensures privacy, it limits the system's ability to handle complex planning tasks that require:

- Multi-step reasoning
- Creative problem solving
- Domain expertise synthesis
- Long-form strategic planning

**Solution:** Intelligent routing between local and cloud AI with automatic sanitization.

---

## Architecture

### High-Level Flow

```
User Query
    ↓
Query Analysis → Is Complex? → Yes → Sanitization → Claude API → Re-personalization
    ↓                 ↓
    No                Personal/Sensitive? → Yes → Ollama (local)
    ↓
Ollama (local)
```

### Components

#### 1. Content Sanitizer
- **Purpose:** Strip personal/sensitive information before cloud requests
- **Location:** `SeleneChat/Sources/Services/ContentSanitizerService.swift`
- **Function:** Replace personal data with generic placeholders

#### 2. Query Router  
- **Purpose:** Decide local vs cloud based on complexity and sensitivity
- **Location:** `SeleneChat/Sources/Services/QueryRouterService.swift`
- **Logic:** 
  - Complex + Non-sensitive → Cloud (sanitized)
  - Complex + Sensitive → Local
  - Simple → Local (default)

#### 3. Re-personalizer
- **Purpose:** Add back personal context to cloud responses
- **Location:** `SeleneChat/Sources/Services/RepersonalizationService.swift`
- **Function:** Map generic placeholders back to personal entities

---

## Privacy Framework

### Sanitization Levels

**Strict (Default)**
- Remove: Names, addresses, phone numbers, emails
- Remove: Specific project names, company names
- Keep: Concepts, relationships, temporal patterns

**Balanced**
- Remove: Personal identifiers only
- Keep: Project contexts, general location info
- Keep: Professional/domain context

**Permissive**  
- Remove: Only explicit PII (SSN, credit cards)
- Keep: Most context for maximum AI capability
- User explicitly accepts data sharing

### Sensitivity Detection

```typescript
interface SensitivityMarkers {
  personalIdentifiers: string[]  // Names, emails, phones
  locationData: string[]         // Addresses, specific places
  financialInfo: string[]        // Account numbers, salaries
  medicalInfo: string[]          // Health conditions, medications
  relationships: string[]        // Family, intimate details
}
```

### User Controls

- **Per-query override:** "Use cloud for this complex request"
- **Session-level setting:** Toggle in conversation header
- **Global preference:** Settings panel with explanation
- **Transparency:** Show what was sanitized

---

## Implementation Plan

### Phase 1: Core Infrastructure (Week 1)

1. **ContentSanitizerService**
   - PII detection patterns
   - Placeholder generation
   - Sanitization transparency logging

2. **QueryRouterService** 
   - Complexity scoring algorithm
   - Sensitivity detection
   - Routing decision logic

3. **RepersonalizationService**
   - Placeholder mapping
   - Context restoration
   - Response enhancement

### Phase 2: Integration (Week 2)

4. **AIProviderService Enhancement**
   - Integrate sanitization pipeline
   - Route through new services
   - Maintain existing local-only option

5. **UI Controls**
   - Privacy level selector
   - Per-query cloud toggle
   - Sanitization transparency display

6. **Settings Integration**
   - Global privacy preferences
   - API key management
   - Usage logging controls

### Phase 3: Testing & Refinement (Week 3)

7. **Privacy Validation**
   - Verify no PII leakage
   - Test sanitization effectiveness
   - Validate re-personalization accuracy

8. **Quality Assessment**
   - Compare local vs cloud response quality
   - Measure sanitization impact
   - User experience testing

---

## Technical Specifications

### ContentSanitizerService

```swift
actor ContentSanitizerService {
    enum PrivacyLevel {
        case strict, balanced, permissive
    }
    
    struct SanitizationResult {
        let sanitizedText: String
        let placeholders: [String: String]  // original -> placeholder
        let sensitivityScore: Double
        let removedElements: [String]
    }
    
    func sanitize(_ text: String, level: PrivacyLevel) async -> SanitizationResult
    func canSendToCloud(_ text: String, level: PrivacyLevel) async -> Bool
}
```

### QueryRouterService

```swift
actor QueryRouterService {
    enum QueryComplexity {
        case simple, moderate, complex
    }
    
    enum RoutingDecision {
        case local(reason: String)
        case cloud(sanitized: Bool, reason: String)
    }
    
    func analyzeQuery(_ text: String) async -> QueryComplexity
    func routeQuery(_ text: String, userPreference: AIProvider) async -> RoutingDecision
}
```

### RepersonalizationService

```swift
actor RepersonalizationService {
    func repersonalize(
        _ response: String, 
        using placeholders: [String: String]
    ) async -> String
    
    func enhanceWithPersonalContext(
        _ response: String,
        originalQuery: String,
        userContext: PersonalContext?
    ) async -> String
}
```

---

## Security Measures

### Data Flow Validation
- **Input logging:** What gets sanitized (local only)
- **Output validation:** Verify no PII in cloud requests
- **Response logging:** Track cloud API interactions

### Privacy Safeguards
- **Local processing first:** Always try local for sensitive content
- **User consent:** Explicit opt-in for cloud features
- **Data retention:** No storage of cloud interactions
- **Audit trail:** Log routing decisions for transparency

### API Security
- **Key management:** Secure storage of Claude API keys
- **Request signing:** Authenticate all cloud requests
- **Rate limiting:** Respect API usage limits
- **Error handling:** Graceful degradation to local

---

## Success Metrics

### Privacy Protection
- **Zero PII leakage:** No personal data in cloud requests (verified by audit)
- **User confidence:** User feels safe using cloud features
- **Transparency:** User understands what data is shared

### Quality Improvement  
- **Complex query handling:** 3x improvement in multi-step reasoning
- **Planning capability:** Generate actionable project breakdowns
- **Response coherence:** Maintain context across long conversations

### User Experience
- **Seamless switching:** No friction between local/cloud modes
- **Performance:** <2s additional latency for cloud requests
- **Reliability:** 99% uptime for routing decisions

---

## Future Enhancements

### Advanced Sanitization
- **Context-aware removal:** Understand relationship between entities
- **Semantic preservation:** Keep meaning while removing identifiers
- **Industry-specific patterns:** Medical, legal, financial sanitization

### Intelligent Caching
- **Response caching:** Store sanitized query results locally
- **Pattern recognition:** Learn which queries benefit from cloud
- **Adaptive routing:** Improve routing based on success metrics

### Multi-Provider Support
- **Provider selection:** Choose between Claude, GPT-4, etc.
- **Capability matching:** Route based on provider strengths
- **Cost optimization:** Balance quality vs API costs

---

## Implementation Notes

This design builds on existing SeleneChat architecture:
- Extends current AIProviderService with routing logic
- Reuses existing Claude API integration from Phase 7.2
- Maintains backward compatibility with local-only mode
- Follows established ADHD-focused design principles

Next step: Create implementation plan with specific tasks and timeline.
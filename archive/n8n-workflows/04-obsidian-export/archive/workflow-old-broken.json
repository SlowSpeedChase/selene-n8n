{
  "name": "Selene: Obsidian Export (ADHD-Optimized)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 * * * *"
            }
          ]
        }
      },
      "id": "cron-export",
      "name": "Every Hour",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "obsidian-export",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-on-demand",
      "name": "On-Demand Export Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 500],
      "webhookId": "obsidian-export-trigger"
    },
    {
      "parameters": {
        "functionCode": "const Database = require('better-sqlite3');\n\ntry {\n  const db = new Database('/selene/data/selene.db', { readonly: true });\n  \n  const query = `SELECT\n    rn.id, rn.title, rn.content, rn.created_at, rn.tags, rn.word_count,\n    pn.concepts, pn.primary_theme, pn.secondary_themes,\n    pn.overall_sentiment, pn.sentiment_score, pn.emotional_tone,\n    pn.energy_level, pn.sentiment_data\n  FROM raw_notes rn\n  JOIN processed_notes pn ON rn.id = pn.raw_note_id\n  WHERE rn.exported_to_obsidian = 0\n    AND rn.status = 'processed'\n    AND pn.sentiment_analyzed = 1\n  ORDER BY rn.created_at DESC\n  LIMIT 50`;\n  \n  const stmt = db.prepare(query);\n  const results = stmt.all();\n  \n  db.close();\n  \n  // Return results as separate items\n  return results.map(row => ({ json: row }));\n  \n} catch (error) {\n  console.error('Database Query Error:', error);\n  throw new Error(`Failed to fetch notes for export: ${error.message}`);\n}"
      },
      "id": "function-get-notes",
      "name": "Get Notes for Export",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "functionCode": "const note = $json;\n\n// Parse JSON fields\nlet concepts = [];\nlet secondaryThemes = [];\nlet tags = [];\nlet sentimentData = {};\n\ntry {\n  concepts = JSON.parse(note.concepts || '[]');\n} catch (e) {\n  concepts = [];\n}\n\ntry {\n  secondaryThemes = JSON.parse(note.secondary_themes || '[]');\n} catch (e) {\n  secondaryThemes = [];\n}\n\ntry {\n  tags = JSON.parse(note.tags || '[]');\n} catch (e) {\n  tags = [];\n}\n\ntry {\n  sentimentData = JSON.parse(note.sentiment_data || '{}');\n} catch (e) {\n  sentimentData = {\n    adhd_markers: {},\n    key_emotions: [],\n    stress_indicators: false\n  };\n}\n\n// Extract ADHD markers\nconst adhdMarkers = sentimentData.adhd_markers || {};\nconst keyEmotions = sentimentData.key_emotions || [];\nconst stressIndicators = sentimentData.stress_indicators || false;\n\n// Format date\nconst date = new Date(note.created_at);\nconst dateStr = date.toISOString().split('T')[0];\nconst timeStr = date.toTimeString().split(' ')[0].substring(0, 5);\nconst year = date.getFullYear();\nconst month = String(date.getMonth() + 1).padStart(2, '0');\nconst dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });\n\n// ==== ADHD-OPTIMIZED: Visual Status Indicators ====\n\n// Energy level emoji\nconst energyEmoji = {\n  'high': 'âš¡',\n  'medium': 'ðŸ”‹',\n  'low': 'ðŸª«'\n}[note.energy_level] || 'ðŸ”‹';\n\n// Emotional tone emoji\nconst emotionEmoji = {\n  'excited': 'ðŸš€',\n  'calm': 'ðŸ˜Œ',\n  'anxious': 'ðŸ˜°',\n  'frustrated': 'ðŸ˜¤',\n  'content': 'ðŸ˜Š',\n  'overwhelmed': 'ðŸ¤¯',\n  'motivated': 'ðŸ’ª',\n  'focused': 'ðŸŽ¯'\n}[note.emotional_tone] || 'ðŸ’­';\n\n// Sentiment emoji\nconst sentimentEmoji = {\n  'positive': 'âœ…',\n  'negative': 'âš ï¸',\n  'neutral': 'âšª',\n  'mixed': 'ðŸ”€'\n}[note.overall_sentiment] || 'âšª';\n\n// ADHD marker badges\nconst adhdBadges = [];\nif (adhdMarkers.overwhelm) adhdBadges.push('ðŸ§  OVERWHELM');\nif (adhdMarkers.hyperfocus) adhdBadges.push('ðŸŽ¯ HYPERFOCUS');\nif (adhdMarkers.executive_dysfunction) adhdBadges.push('âš ï¸ EXEC-DYS');\nif (stressIndicators) adhdBadges.push('ðŸ˜° STRESS');\n\nconst adhdBadgeStr = adhdBadges.length > 0 ? adhdBadges.join(' | ') : 'âœ¨ BASELINE';\n\n// ==== ADHD-OPTIMIZED: Extract Action Items ====\nconst actionItems = [];\nconst todoPatterns = [\n  /^[-*]\\s*\\[[ x]\\]\\s*(.+)$/gim,\n  /^[-*]\\s*(TODO|TASK|ACTION)[:)]\\s*(.+)$/gim,\n  /\\b(need to|should|must|have to|remember to)\\s+([^.!?]+)/gi\n];\n\ntodoPatterns.forEach(pattern => {\n  let match;\n  while ((match = pattern.exec(note.content)) !== null) {\n    const item = (match[1] || match[2] || '').trim();\n    if (item.length > 5 && item.length < 200) {\n      actionItems.push(item);\n    }\n  }\n});\n\nconst uniqueActions = [...new Set(actionItems)].slice(0, 10);\n\n// ==== ADHD-OPTIMIZED: Generate TL;DR ====\nconst firstSentences = note.content.split(/[.!?]\\s+/).slice(0, 2).join('. ');\nconst tldr = firstSentences.length > 200 ? \n  firstSentences.substring(0, 200) + '...' : \n  firstSentences;\n\n// ==== ADHD-OPTIMIZED: Context Box ====\nconst readingTime = Math.ceil(note.word_count / 200);\nconst contextBox = `> **âš¡ Quick Context**\n> ${tldr}\n> \n> **Why this matters:** Related to ${concepts.slice(0, 2).join(', ')}\n> **Reading time:** ${readingTime} min\n> **Brain state:** ${note.energy_level} energy, ${note.emotional_tone}`;\n\n// ==== Build Enhanced Frontmatter ====\nconst allTags = [\n  note.primary_theme,\n  ...secondaryThemes,\n  ...tags,\n  `energy-${note.energy_level}`,\n  `mood-${note.emotional_tone}`,\n  `sentiment-${note.overall_sentiment}`\n].filter((t, i, arr) => t && arr.indexOf(t) === i);\n\nif (adhdMarkers.overwhelm) allTags.push('adhd/overwhelm');\nif (adhdMarkers.hyperfocus) allTags.push('adhd/hyperfocus');\nif (stressIndicators) allTags.push('state/stressed');\n\nconst frontmatter = `---\ntitle: \"${note.title.replace(/\"/g, '\\\\\"')}\"\ndate: ${dateStr}\ntime: ${timeStr}\nday: ${dayOfWeek}\ntheme: ${note.primary_theme}\nenergy: ${note.energy_level}\nmood: ${note.emotional_tone}\nsentiment: ${note.overall_sentiment}\nsentiment_score: ${note.sentiment_score || 0.5}\nconcepts:\n${concepts.map(c => `  - ${c}`).join('\\n')}\ntags:\n${allTags.map(t => `  - ${t}`).join('\\n')}\nadhd_markers:\n  overwhelm: ${adhdMarkers.overwhelm || false}\n  hyperfocus: ${adhdMarkers.hyperfocus || false}\n  executive_dysfunction: ${adhdMarkers.executive_dysfunction || false}\nstress: ${stressIndicators}\naction_items: ${uniqueActions.length}\nreading_time: ${readingTime}\nword_count: ${note.word_count}\nsource: Selene\nautomated: true\n---`;\n\n// ==== Build ADHD-Optimized Markdown ====\n\nconst statusHeader = `# ${emotionEmoji} ${note.title}\n\n## ðŸŽ¯ Status at a Glance\n\n| Indicator | Status | Details |\n|-----------|--------|----------|\n| Energy | ${energyEmoji} ${note.energy_level.toUpperCase()} | Brain capacity indicator |\n| Mood | ${emotionEmoji} ${note.emotional_tone} | Emotional state |\n| Sentiment | ${sentimentEmoji} ${note.overall_sentiment} | Overall tone (${Math.round(note.sentiment_score * 100)}%) |\n| ADHD | ${adhdBadgeStr} | Markers detected |\n| Actions | ðŸŽ¯ ${uniqueActions.length} items | Tasks extracted |\n\n---`;\n\nconst conceptLinks = concepts.map(c => `[[Concepts/${c}]]`).join(' â€¢ ');\nconst themeLinks = [note.primary_theme, ...secondaryThemes]\n  .map(t => `[[Themes/${t}]]`)\n  .join(' â€¢ ');\n\nconst metadataSection = `\n**ðŸ·ï¸ Theme**: ${themeLinks}\n**ðŸ’¡ Concepts**: ${conceptLinks}\n**ðŸ“… Created**: ${dateStr} (${dayOfWeek}) at ${timeStr}\n**â±ï¸ Reading Time**: ${readingTime} min\n\n---\n\n${contextBox}\n\n---`;\n\nconst actionItemsSection = uniqueActions.length > 0 ? `\n## âœ… Action Items Detected\n\n${uniqueActions.map(item => `- [ ] ${item}`).join('\\n')}\n\n> **Tip:** Copy these to your daily todo list or use Obsidian Tasks plugin\n\n---` : '';\n\nconst contentSection = `\n## ðŸ“ Full Content\n\n${note.content}\n\n---`;\n\nconst insightsSection = `\n## ðŸ§  ADHD Insights\n\n### Brain State Analysis\n\n- **Energy Level**: ${note.energy_level} ${energyEmoji}\n  - ${note.energy_level === 'high' ? 'âš¡ Great time for complex tasks' : note.energy_level === 'low' ? 'ðŸª« Consider rest or easy tasks' : 'ðŸ”‹ Moderate capacity available'}\n  \n- **Emotional Tone**: ${note.emotional_tone} ${emotionEmoji}\n  - ${adhdMarkers.overwhelm ? 'âš ï¸ Signs of overwhelm detected - consider breaking tasks down' : ''}\n  - ${adhdMarkers.hyperfocus ? 'ðŸŽ¯ Hyperfocus detected - valuable insights likely!' : ''}\n  - ${stressIndicators ? 'ðŸ˜° Stress indicators present - be gentle with yourself' : ''}\n\n- **Sentiment**: ${note.overall_sentiment} (${Math.round(note.sentiment_score * 100)}%)\n\n${keyEmotions.length > 0 ? `### Key Emotions\n${keyEmotions.map(e => `- ${e}`).join('\\n')}` : ''}\n\n### Context Clues\n\n- **When was this?** ${dayOfWeek}, ${dateStr} at ${timeStr}\n- **What was I thinking about?** ${concepts.slice(0, 3).join(', ')}\n- **Theme**: ${note.primary_theme}\n- **How did I feel?** ${note.emotional_tone}, ${note.overall_sentiment}\n\n> **Memory Trigger**: Look for related notes tagged with these concepts to restore full context\n\n---`;\n\nconst metadataFooter = `\n## ðŸ“Š Processing Metadata\n\n- **Processed**: ${new Date().toISOString().split('T')[0]}\n- **Source**: Selene Knowledge Management System\n- **Concept Count**: ${concepts.length}\n- **Word Count**: ${note.word_count}\n- **Sentiment Confidence**: ${Math.round((sentimentData.analysis_confidence || 0.5) * 100)}%\n\n## ðŸ”— Related Notes\n\n*Obsidian will automatically show backlinks here based on shared concepts and tags*\n\n---\n\n*ðŸ¤– This note was automatically processed and optimized for ADHD by Selene*\n`;\n\nconst markdown = `${frontmatter}\n\n${statusHeader}\n\n${metadataSection}\n\n${actionItemsSection}\n\n${contentSection}\n\n${insightsSection}\n\n${metadataFooter}`;\n\n// ==== Generate Multiple File Paths for Different Organization ====\n\nconst titleSlug = note.title\n  .toLowerCase()\n  .replace(/[^a-z0-9\\s-]/g, '')\n  .replace(/\\s+/g, '-')\n  .substring(0, 50);\n\nconst vaultPath = process.env.OBSIDIAN_VAULT_PATH || '/Users/chaseeasterling/selene-n8n/vault';\n\n// Primary: By date (for chronological backup)\nconst dateDir = `${vaultPath}/Selene/Timeline/${year}/${month}`;\nconst dateFile = `${dateDir}/${dateStr}-${titleSlug}.md`;\n\n// Secondary: By primary concept (for context retrieval)\nconst primaryConcept = concepts[0] || 'uncategorized';\nconst conceptDir = `${vaultPath}/Selene/By-Concept/${primaryConcept}`;\nconst conceptFile = `${conceptDir}/${dateStr}-${titleSlug}.md`;\n\n// Tertiary: By theme\nconst themeDir = `${vaultPath}/Selene/By-Theme/${note.primary_theme}`;\nconst themeFile = `${themeDir}/${dateStr}-${titleSlug}.md`;\n\n// Quaternary: By energy level (for state-based filtering)\nconst energyDir = `${vaultPath}/Selene/By-Energy/${note.energy_level}`;\nconst energyFile = `${energyDir}/${dateStr}-${titleSlug}.md`;\n\nreturn {\n  json: {\n    noteId: note.id,\n    filename: `${dateStr}-${titleSlug}.md`,\n    markdown: markdown,\n    \n    // Multiple organization paths\n    dateDir: dateDir,\n    dateFile: dateFile,\n    conceptDir: conceptDir,\n    conceptFile: conceptFile,\n    themeDir: themeDir,\n    themeFile: themeFile,\n    energyDir: energyDir,\n    energyFile: energyFile,\n    \n    // Metadata for downstream processing\n    year: year,\n    month: month,\n    concepts: concepts,\n    theme: note.primary_theme,\n    energy: note.energy_level,\n    mood: note.emotional_tone,\n    adhdMarkers: adhdMarkers,\n    hasActions: uniqueActions.length > 0,\n    actionItems: uniqueActions\n  }\n};"
      },
      "id": "function-build-adhd-markdown",
      "name": "Build ADHD-Optimized Markdown",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "functionCode": "const fs = require('fs');\nconst path = require('path');\n\n// Create all directories\nconst dirs = [\n  $json.dateDir,\n  $json.conceptDir,\n  $json.themeDir,\n  $json.energyDir\n];\n\nfor (const dir of dirs) {\n  if (dir) {\n    fs.mkdirSync(dir, { recursive: true });\n  }\n}\n\nreturn items;"
      },
      "id": "function-create-directories",
      "name": "Create All Directories",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "functionCode": "const fs = require('fs');\n\nconst filePath = $json.dateFile;\nconst content = $json.markdown;\n\nfs.writeFileSync(filePath, content, 'utf8');\n\nreturn items;"
      },
      "id": "file-write-date",
      "name": "Write to Timeline",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "functionCode": "const fs = require('fs');\n\nconst filePath = $json.conceptFile;\nconst content = $json.markdown;\n\nfs.writeFileSync(filePath, content, 'utf8');\n\nreturn items;"
      },
      "id": "file-write-concept",
      "name": "Write to Concept Folder",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "functionCode": "const fs = require('fs');\n\nconst filePath = $json.themeFile;\nconst content = $json.markdown;\n\nfs.writeFileSync(filePath, content, 'utf8');\n\nreturn items;"
      },
      "id": "file-write-theme",
      "name": "Write to Theme Folder",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "functionCode": "const fs = require('fs');\n\nconst filePath = $json.energyFile;\nconst content = $json.markdown;\n\nfs.writeFileSync(filePath, content, 'utf8');\n\nreturn items;"
      },
      "id": "file-write-energy",
      "name": "Write to Energy Folder",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 600]
    },
    {
      "parameters": {
        "functionCode": "const Database = require('better-sqlite3');\n\nconst noteId = $json.noteId;\n\ntry {\n  const db = new Database('/selene/data/selene.db');\n  \n  const query = `UPDATE raw_notes\n    SET exported_to_obsidian = 1,\n        exported_at = datetime('now')\n    WHERE id = ?`;\n  \n  const stmt = db.prepare(query);\n  const result = stmt.run(noteId);\n  \n  db.close();\n  \n  return { json: { noteId: noteId, updated: result.changes > 0 } };\n  \n} catch (error) {\n  console.error('Database Update Error:', error);\n  throw new Error(`Failed to mark note as exported: ${error.message}`);\n}"
      },
      "id": "function-mark-exported",
      "name": "Mark as Exported",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "functionCode": "const concepts = $('Build ADHD-Optimized Markdown').item.json.concepts;\nconst vaultPath = process.env.OBSIDIAN_VAULT_PATH || '/Users/chaseeasterling/selene-n8n/vault';\n\nconst conceptFiles = concepts.map(concept => {\n  const conceptPath = `${vaultPath}/Selene/Concepts/${concept}.md`;\n  \n  const conceptContent = `# ${concept}\n\n**Type**: Concept Index\n**Created**: ${new Date().toISOString().split('T')[0]}\n**Auto-generated**: Yes\n\n## ðŸŽ¯ What is this?\n\nThis is a hub page for all notes related to **${concept}**. Obsidian will automatically show backlinks below.\n\n## ðŸ“š Related Notes\n\n*Backlinks will appear here automatically*\n\n## ðŸ§  ADHD Tips\n\n- Use this page to see all notes about ${concept} in one place\n- Great for refreshing your memory before diving into a specific note\n- Check the backlinks section to find related context\n\n---\n\n*Auto-generated by Selene - edit freely!*\n`;\n\n  return {\n    path: conceptPath,\n    content: conceptContent,\n    concept: concept\n  };\n});\n\nreturn conceptFiles.map(cf => ({ json: cf }));"
      },
      "id": "function-create-concept-hubs",
      "name": "Create Concept Hub Pages",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 750]
    },
    {
      "parameters": {
        "functionCode": "const fs = require('fs');\nconst path = require('path');\n\n// Get the directory from the path\nconst filePath = $json.path;\nconst dir = path.dirname(filePath);\n\n// Create directory if it doesn't exist\nif (dir) {\n  fs.mkdirSync(dir, { recursive: true });\n}\n\nreturn items;"
      },
      "id": "function-create-concepts-dir",
      "name": "Create Concepts Directory",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 750]
    },
    {
      "parameters": {
        "functionCode": "const fs = require('fs');\n\nconst filePath = $json.path;\nconst content = $json.content;\n\n// Only write if file doesn't exist (flag 'wx' behavior)\ntry {\n  if (!fs.existsSync(filePath)) {\n    fs.writeFileSync(filePath, content, 'utf8');\n  }\n} catch (error) {\n  // Fail silently (continueOnFail: true)\n  console.log('File already exists or error:', filePath);\n}\n\nreturn items;"
      },
      "id": "file-write-concept-hub",
      "name": "Write Concept Hub (if new)",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1450, 750],
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Export triggered successfully\", \"timestamp\": new Date().toISOString() } }}"
      },
      "id": "webhook-respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1450, 500]
    }
  ],
  "connections": {
    "Every Hour": {
      "main": [
        [
          {
            "node": "Get Notes for Export",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "On-Demand Export Webhook": {
      "main": [
        [
          {
            "node": "Get Notes for Export",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Notes for Export": {
      "main": [
        [
          {
            "node": "Build ADHD-Optimized Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build ADHD-Optimized Markdown": {
      "main": [
        [
          {
            "node": "Create All Directories",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Concept Hub Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create All Directories": {
      "main": [
        [
          {
            "node": "Write to Timeline",
            "type": "main",
            "index": 0
          },
          {
            "node": "Write to Concept Folder",
            "type": "main",
            "index": 0
          },
          {
            "node": "Write to Theme Folder",
            "type": "main",
            "index": 0
          },
          {
            "node": "Write to Energy Folder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write to Timeline": {
      "main": [
        [
          {
            "node": "Mark as Exported",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write to Concept Folder": {
      "main": [
        [
          {
            "node": "Mark as Exported",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write to Theme Folder": {
      "main": [
        [
          {
            "node": "Mark as Exported",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write to Energy Folder": {
      "main": [
        [
          {
            "node": "Mark as Exported",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark as Exported": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Concept Hub Pages": {
      "main": [
        [
          {
            "node": "Create Concepts Directory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Concepts Directory": {
      "main": [
        [
          {
            "node": "Write Concept Hub (if new)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Selene",
      "id": "selene-tag"
    },
    {
      "name": "ADHD",
      "id": "adhd-tag"
    }
  ],
  "meta": {
    "instanceId": "selene-local"
  },
  "pinData": {}
}

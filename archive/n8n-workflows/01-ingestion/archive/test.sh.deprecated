#!/bin/bash

# Ingestion Workflow Test Script
# Tests all functionality of the note ingestion workflow

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
WEBHOOK_URL="http://localhost:5678/webhook/api/drafts"
DB_PATH="data/selene.db"

# Test counters
PASSED=0
FAILED=0
TOTAL=0

echo "=========================================="
echo "Selene Ingestion Workflow Test Suite"
echo "=========================================="
echo ""

# Helper function to run a test
run_test() {
    local test_name="$1"
    local test_command="$2"
    local expected_pattern="$3"

    TOTAL=$((TOTAL + 1))
    echo -n "Test $TOTAL: $test_name... "

    # Run the command and capture output
    response=$(eval "$test_command" 2>&1)

    # Check if response matches expected pattern
    if echo "$response" | grep -q "$expected_pattern"; then
        echo -e "${GREEN}PASS${NC}"
        PASSED=$((PASSED + 1))
        return 0
    else
        echo -e "${RED}FAIL${NC}"
        echo "  Expected pattern: $expected_pattern"
        echo "  Got response: $response"
        FAILED=$((FAILED + 1))
        return 1
    fi
}

# Helper function to check database
check_db() {
    local query="$1"
    local expected="$2"

    result=$(sqlite3 "$DB_PATH" "$query" 2>&1)

    if [ "$result" = "$expected" ]; then
        return 0
    else
        echo "  DB Check Failed - Expected: '$expected', Got: '$result'"
        return 1
    fi
}

echo "Pre-flight Checks:"
echo "=================="

# Check if n8n is running
echo -n "Checking if n8n is running... "
if curl -s http://localhost:5678/healthz > /dev/null 2>&1; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAIL${NC}"
    echo "Error: n8n is not running. Start it with: docker-compose up -d"
    exit 1
fi

# Check if database exists
echo -n "Checking if database exists... "
if [ -f "$DB_PATH" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${YELLOW}WARNING${NC}"
    echo "Database not found. Creating it..."
    sqlite3 "$DB_PATH" < database/schema.sql
fi

# Clear any existing test data
echo -n "Cleaning test data... "
sqlite3 "$DB_PATH" "DELETE FROM raw_notes WHERE title LIKE 'Test%' OR title LIKE '%Test%';" 2>/dev/null || true
echo -e "${GREEN}OK${NC}"

echo ""
echo "Running Tests:"
echo "=============="

# Test 1: Basic Note Ingestion
run_test "Basic note ingestion" \
    "curl -s -X POST '$WEBHOOK_URL' -H 'Content-Type: application/json' -d '{\"title\":\"Test Note 1\",\"content\":\"This is a basic test note.\",\"created_at\":\"2025-10-29T22:00:00Z\"}'" \
    '"success":true'

if [ $? -eq 0 ]; then
    echo -n "  Verifying in database... "
    if check_db "SELECT COUNT(*) FROM raw_notes WHERE title = 'Test Note 1';" "1"; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC}"
        FAILED=$((FAILED + 1))
    fi
fi

# Test 2: Note with Tags
run_test "Tag extraction" \
    "curl -s -X POST '$WEBHOOK_URL' -H 'Content-Type: application/json' -d '{\"title\":\"Tagged Note\",\"content\":\"This has #productivity and #testing tags.\",\"created_at\":\"2025-10-29T22:05:00Z\"}'" \
    '"success":true'

if [ $? -eq 0 ]; then
    echo -n "  Verifying tags in database... "
    tags=$(sqlite3 "$DB_PATH" "SELECT tags FROM raw_notes WHERE title = 'Tagged Note';")
    if echo "$tags" | grep -q "productivity" && echo "$tags" | grep -q "testing"; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC}"
        echo "  Expected tags containing 'productivity' and 'testing', got: $tags"
        FAILED=$((FAILED + 1))
    fi
fi

# Test 3: Duplicate Detection
run_test "Duplicate detection" \
    "curl -s -X POST '$WEBHOOK_URL' -H 'Content-Type: application/json' -d '{\"title\":\"Test Note 1\",\"content\":\"This is a basic test note.\",\"created_at\":\"2025-10-29T22:00:00Z\"}'" \
    'duplicate_skipped'

if [ $? -eq 0 ]; then
    echo -n "  Verifying no duplicate in database... "
    if check_db "SELECT COUNT(*) FROM raw_notes WHERE title = 'Test Note 1';" "1"; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC}"
        FAILED=$((FAILED + 1))
    fi
fi

# Test 4: Long Content
run_test "Long content handling" \
    "curl -s -X POST '$WEBHOOK_URL' -H 'Content-Type: application/json' -d '{\"title\":\"Long Form Note\",\"content\":\"This is a much longer note with multiple paragraphs.\\n\\nIt contains several sentences and spans multiple lines.\\n\\nWe want to test that word count works correctly.\",\"created_at\":\"2025-10-29T22:10:00Z\"}'" \
    '"success":true'

if [ $? -eq 0 ]; then
    echo -n "  Verifying word count... "
    word_count=$(sqlite3 "$DB_PATH" "SELECT word_count FROM raw_notes WHERE title = 'Long Form Note';")
    if [ "$word_count" -gt 20 ] && [ "$word_count" -lt 50 ]; then
        echo -e "${GREEN}OK${NC} (word_count: $word_count)"
    else
        echo -e "${YELLOW}WARNING${NC} (unexpected word_count: $word_count)"
    fi
fi

# Test 5: Minimal Required Fields
run_test "Minimal fields (no title)" \
    "curl -s -X POST '$WEBHOOK_URL' -H 'Content-Type: application/json' -d '{\"content\":\"Minimal note with no title\"}'" \
    '"success":true'

if [ $? -eq 0 ]; then
    echo -n "  Verifying default title... "
    title=$(sqlite3 "$DB_PATH" "SELECT title FROM raw_notes WHERE content = 'Minimal note with no title';")
    if [ "$title" = "Untitled Note" ]; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${YELLOW}WARNING${NC} (title: $title)"
    fi
fi

# Test 6: Empty Content Error
run_test "Empty content rejection" \
    "curl -s -X POST '$WEBHOOK_URL' -H 'Content-Type: application/json' -d '{\"title\":\"Empty Note\",\"content\":\"\"}'" \
    'error\|Error\|required'

# Test 7: Alternative Input Format
run_test "Query parameter format" \
    "curl -s -X POST '$WEBHOOK_URL' -H 'Content-Type: application/json' -d '{\"query\":{\"title\":\"Query Format Note\",\"content\":\"Testing alternative format\",\"timestamp\":\"2025-10-29T22:15:00Z\"}}'" \
    '"success":true'

echo ""
echo "=========================================="
echo "Test Summary"
echo "=========================================="
echo "Total Tests: $TOTAL"
echo -e "Passed: ${GREEN}$PASSED${NC}"
echo -e "Failed: ${RED}$FAILED${NC}"
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All tests passed!${NC} ✅"
    echo ""
    echo "Database Status:"
    echo "================"
    sqlite3 "$DB_PATH" "SELECT id, title, word_count, status FROM raw_notes ORDER BY id DESC LIMIT 10;"
    echo ""
    exit 0
else
    echo -e "${RED}Some tests failed.${NC} ❌"
    echo ""
    echo "Check the output above for details."
    echo "Review TEST.md for expected behavior."
    echo ""
    exit 1
fi

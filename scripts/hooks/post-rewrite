#!/bin/bash
# Post-rewrite hook: Auto-build SeleneChat after rebase/amend
# Receives: rebase or amend as first argument

set -e

REWRITE_TYPE="$1"

# Only run for rebases (amend is usually single-file changes)
if [ "$REWRITE_TYPE" != "rebase" ]; then
    exit 0
fi

# Read the old/new refs from stdin (format: old-sha new-sha)
# We only need the first and last to check the full range
FIRST_OLD=""
LAST_NEW=""
while read OLD_SHA NEW_SHA; do
    if [ -z "$FIRST_OLD" ]; then
        FIRST_OLD="$OLD_SHA"
    fi
    LAST_NEW="$NEW_SHA"
done

if [ -n "$FIRST_OLD" ] && [ -n "$LAST_NEW" ]; then
    SCRIPT_DIR="$(dirname "$0")"
    # Handle symlinked hooks
    if [ -L "$0" ]; then
        SCRIPT_DIR="$(dirname "$(readlink "$0")")"
    fi
    "$SCRIPT_DIR/selenechat-auto-build.sh" "$FIRST_OLD" "$LAST_NEW"
fi
